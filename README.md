# Project IaC

Infrastructure-as-Code for SberCloud (ru-moscow-1). It provisions networking (VPC, subnet, security groups), a Kubernetes cluster (CCE) with node pools, PostgreSQL instances, and deploys Jenkins, Jira, and Bitbucket via Helm.

## Structure

- terraform/
  - dev/: Development environment (cluster, DB, storage, apps)
  - prod/: Production environment (cluster, DB, storage, apps)
  - terraform.tfvars.example: Sample variables file to copy per environment

## Prerequisites

- Terraform installed
- SberCloud account with Access Key/Secret Key
- S3-compatible bucket in SberCloud OBS for Terraform remote state (default name: `terraformbucket`, region: `ru-moscow-1`). Create it beforehand or adjust `backend.tf` in each env.

## Security Features

- **Restricted Access**: SSH and Kubernetes API access limited to specific IP ranges
- **Individual Database Passwords**: Each service (Jenkins, Jira, Bitbucket) can have separate database passwords
- **Production SSL**: HTTPS with TLS termination and forced SSL redirect in production
- **Network Isolation**: PostgreSQL accessible only from VPC CIDR range
- **Versioned Helm Charts**: Pinned chart versions for reproducible deployments

## Quick Start

1) Pick an environment and change directory:
   - `cd terraform/dev` or `cd terraform/prod`
2) Copy and edit variables:
   - `cp ../terraform.tfvars.example ./terraform.tfvars`
   - Fill in `access_key`, `secret_key`, and database passwords for the env
   - **IMPORTANT**: Update `admin_ip_ranges` with your actual IP ranges for security
3) Export backend credentials for OBS (used by the Terraform S3 backend):
   - `export AWS_ACCESS_KEY_ID=...`
   - `export AWS_SECRET_ACCESS_KEY=...`
4) Initialize and apply:
   - `terraform init`
   - `terraform plan`
   - `terraform apply`

Destroy the environment from the same directory with `terraform destroy`.

## Configuration Variables

### Required Variables
- `access_key`: SberCloud access key
- `secret_key`: SberCloud secret key  
- `dev_postgres_password` / `prod_postgres_password`: Master PostgreSQL passwords

### Optional Security Variables
- `jira_db_password`: Individual password for Jira database user
- `bitbucket_db_password`: Individual password for Bitbucket database user  
- `jenkins_db_password`: Individual password for Jenkins database user
- `admin_ip_ranges`: IP ranges allowed for SSH and Kubernetes API access (default: `["10.0.0.0/8"]`)

### Network Variables
- `vpc_cidr`: VPC CIDR block (default: `10.0.0.0/16` for dev, `10.1.0.0/16` for prod)
- `subnet_cidr`: Subnet CIDR block
- `availability_zone`: SberCloud availability zone (default: `ru-moscow-1a`)

## Environment Differences

| Feature | Development | Production |
|---------|-------------|------------|
| Node Count | 1 (min) - 3 (max) | 2 (min) - 5 (max) |
| Node Flavor | s6.large.2 | s6.xlarge.4 |
| Storage Size | 10Gi per service | 20-50Gi per service |
| PostgreSQL | rds.pg.c2.medium, 40GB | rds.pg.c2.large, 100GB |
| Backup Retention | 3 days | 7 days |
| Storage Reclaim | Delete | Retain |
| SSL/TLS | HTTP only | HTTPS with forced SSL |
| High Availability | Single replica | 2 replicas per service |

## Security Notes

- **Change Default IP Ranges**: The default `admin_ip_ranges` allows access from private networks only. Update this with your specific IP ranges.
- **Use Individual Passwords**: For production, set individual database passwords for each service instead of using the master password.
- **DNS Configuration**: Update ingress hosts from placeholder domains (`*.company.local`, `*.company.com`) to your actual domains.
- **Certificate Management**: Production uses cert-manager with Let's Encrypt. Ensure cert-manager is installed in your cluster.

## Notes

- Do not edit anything under `.terraform/`; it is generated by Terraform.
- Keep secrets in `terraform.tfvars` (ignored by VCS via `.gitignore`).
- PostgreSQL endpoints are marked as sensitive outputs for security.